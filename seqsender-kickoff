
#!/bin/bash
# Wrapper to run public-repository-submission pipeline

WORK_DIR=$PWD
RESOURCE_ROOT=/seqsender
seqsender=$RESOURCE_ROOT/seqsender.py
gisaid_uploader=$RESOURCE_ROOT/gisaid_uploader.py
retrieve=$RESOURCE_ROOT/retrieve.py
check=$RESOURCE_ROOT/check.py
config_file=$RESOURCE_ROOT/config_files/default_config.yaml
config_name=default_config.yaml

seqsender_usage(){
	echo ""
	echo "Here is a list of commands:"
	echo ""

	echo "To create the files for submission and adds to automated submission pipeline and starts submission process:"
	echo -e "\t Usage: seqsender submit [-h] --unique_name <> --fasta <> --metadata <> [--config <>] [--test] [--overwrite]"
	echo ""
	
	echo "To create the files for submission:"
	echo -e "\t Usage: seqsender prep [-h] --unique_name <> --fasta <> --metadata <> [--config <>] [--test] [--overwrite]"
	echo ""
	
	echo "To update process of all sequences in submission pipeline, performs submission to subsequent databases based on submission status:"
	echo -e "\t Usage: seqsender update_submissions [-h]"
	echo ""

	echo "To output BioProject ID needed to perform test submissions:"
	echo -e "\t Usage: seqsender test_bioproject [-h] --unique_name <> [--config <>]"
	echo ""

	echo "To perform manual submission to GISAID:"
	echo -e "\t Usage: seqsender gisaid [-h] --unique_name <> [--config <>] [--test] [--overwrite]"
	echo ""

	echo "To perform manual submission to Genbank:"
	echo -e "\t Usage: seqsender genbank [-h] --unique_name <> [--config <>] [--test] [--overwrite]"
	echo ""

	echo "To perform manual submission to BioSample:"
	echo -e "\t Usage: seqsender biosample [-h] --unique_name <> [--config <>] [--test] [--overwrite]"
	echo ""

	echo "To perform manual submission to SRA:"
	echo -e "\t Usage: seqsender sra [-h] --unique_name <> [--config <>] [--test] [--overwrite]"
	echo ""

	echo "To perform manual submission to BioSample/SRA:"
	echo -e "\t Usage: seqsender biosample_sra [-h] --unique_name <> [--config <>] [--test] [--overwrite]"
}

gisaid_uploader_usage(){
	echo ""
	echo "To authenticate GISAID submissions:"
	echo -e "\t Usage: gisaid_uploader [-h] [--proxy <>] [--debug] [--version] [-a AUTHFILE] [-t AUTHTOKEN] [-l LOGFILE] ctx {authenticate,upload,revoke} ..."
}

retrieve_usage(){
	echo ""
	echo "To retrieve a sample file used by seqsender to submit submissions such as config file, metadata file, and required columns file."
	echo -e "\t Usage: retrieve --sample_file <> [--outdir <>]"
}

check_usage(){
	echo ""
	echo "To check status of a submission:"
	echo -e "\t Usage: check --unique_name <>"
}

required_flags(){
	echo ""
	echo "Required flags:"
	echo -e "\t --unique_name <> \t Unique identifier"
	echo -e "\t --metadata <> \t\t Metadata file"
	echo -e "\t --fasta <> \t\t Fasta file"
	echo -e "\t --sample_file <> \t Name of a file to retrieve: config/metadata/required_columns"
	echo ""
}

optional_flags(){
	echo ""
	echo "Optional flags:"
	echo -e "\t -h, --help \t Show this help message and exit."
	echo -e "\t --config <> \t If using a different config file than the default config. Provide the full name of the config file stored in config_files folder."
	echo -e "\t --test \t Performs test submission to NCBI. Does not perform test submission to GISAID. You must used authenticated CID for test submission to GISAID."
	echo -e "\t --overwrite \t Overwrites an existing submission on NCBI FTP. Used to update errored submissions."
	echo -e "\t --outdir \t Output directory to return the file"
	echo ""
}

usage(){
	seqsender_usage;
	gisaid_uploader_usage;
	retrieve_usage;
	check_usage;
	required_flags;
	optional_flags;
}

# Check commands that user provided
case $1 in 
	seqsender) 
		api=$seqsender;
		case $2 in
			"") python3 $api -h; exit 1;;
			*) ;;
		esac
		;;
	gisaid_uploader) 
		api=$gisaid_uploader;
		case $2 in
			"") python3 $api -h; exit 1;;
			*) ;;
		esac
		;;
	retrieve) 
		api=$retrieve;
		case $2 in
			"") python3 $api -h; exit 1;;
			*) ;;
		esac
		;;
	check) 
		api=$check;
		case $2 in
			"") python3 $api -h; exit 1;;
			*) ;;
		esac
		;;
	-h | --help | "") usage; exit 1;;
	*) echo -e "\n$1 is not a valid command.\n"; usage; exit 1;;
esac

# Check commands and flag options that user provided
i=2
n=$#
arg_list=""
unique_name=""
provided_config=""
provided_metadata=""
provided_fasta=""

while [[ i -le $n ]];
do
	var=${@:$i:1}
	#echo $i
	#echo $var
	case "$var" in
		--config)
			# Get arg position
			config_pos=$i
			# Get arg value
			config_path=${@:($config_pos+1):1}
			# echo $config_path
			# Check if config value is empty
			case $config_path in 
				"") echo "\nError: config file not provided\n"; exit 1;;
				*) 
					# Check if config file exists. If exists, copy it to pipeline directory
					provided_config=`echo $config_path | sed "s,^./,$WORK_DIR/,g" | sed "s,//*,/,g"` 
					# echo $provided_config
					config_name=`echo "$provided_config" | awk -F "/" '{print $NF}'`
					#echo $config_name
					config_file=$RESOURCE_ROOT/config_files/$config_name
					# echo $config_file
					if [[ -f $provided_config ]]
					then
						# Get absolute path of the file
						provided_config=`realpath $provided_config` 

						# Copy file to pipeline directory
						cp $provided_config $config_file 2>/dev/null

						# Check if submission directory is provided, if not exist, create a default output directory
						python3 $RESOURCE_ROOT/extract_config.py --config_file $config_file
						
						# Check python3 exit code
						if [[ $? != 0 ]]
						then 
							exit 1
						fi
						
						arg_list+="--config $config_name "
						i=$(($i+2))
					else
						echo -e "\nError: Config file does not exist at: $provided_config\n"
						exit 1
					fi
					;;
			esac
			;;
		--metadata) 
			# Get arg position
			metadata_pos=$i
			# Get arg value
			metadata_path=${@:($metadata_pos+1):1}
			# echo $metadata_path
			# Check if metadata value is empty
			case $metadata_path in 
				"") echo "\nError: metadata file not provided\n"; exit 1;;
				*)	
					# Check if metadata file exists. If exists, copy it to pipeline directory
					provided_metadata=`echo $metadata_path | sed "s,^./,$WORK_DIR/,g" | sed "s,//*,/,g"`
					# echo $provided_metadata
					metadata_name=`echo "$provided_metadata" | awk -F "/" '{print $NF}'`
					# echo $metadata_name
					metadata_file=/tmp/$metadata_name
					# echo $metadata_file
					if [[ -f $provided_metadata ]]
					then
						# Get absolute path of the file
						provided_metadata=`realpath $provided_metadata` 

						# Copy file to pipeline directory
						cp $provided_metadata $metadata_file 2>/dev/null						
						arg_list+="--metadata $metadata_file "
						i=$(($i+2))
					else
						echo -e "\nError: metadata file does not exist at: $provided_metadata\n"
						exit 1
					fi
					;;
			esac
			;; 
		--fasta) 
			# Get arg position
			fasta_pos=$i
			# Get arg value
			fasta_path=${@:($fasta_pos+1):1}
			# echo $fasta_path
			# Check if fasta value is empty
			case $fasta_path in 
				"") echo "\nError: fasta file not provided\n"; exit 1;;
				*)
					# Check if fasta file exists. If exists, copy it to pipeline directory
					provided_fasta=`echo $fasta_path | sed "s,^./,$WORK_DIR/,g" | sed "s,//*,/,g"`
					# echo $provided_fasta
					fasta_name=`echo "$provided_fasta" | awk -F "/" '{print $NF}'`
					# echo $fasta_name
					fasta_file=/tmp/$fasta_name
					# echo $fasta_file
					if [[ -f $provided_fasta ]]
					then
						# Get absolute path of the file
						provided_fasta=`realpath $provided_fasta` 

						# Copy file to pipeline directory
						cp $provided_fasta $fasta_file 2>/dev/null
						arg_list+="--fasta $fasta_file "
						i=$(($i+2))
					else
						echo -e "\nError: fasta file does not exist at: $provided_fasta\n"
						exit 1
					fi
					;;
			esac
			;; 
		--unique_name)
			# Get arg position
			unique_name_pos=$i
			# Get arg value
			unique_name=${@:($unique_name_pos+1):1}
			arg_list+="--unique_name $unique_name "
			i=$(($i+2))
			;; 
		*)
			arg_pos=$i
			arg_val=${@:$arg_pos:1}
			arg_list+="$arg_val "
			i=$(($i+1))
			;; 	
	esac
done

# Extract sra_file_path from metadata file
case $provided_metadata in
	"") ;;
	*)
		# Update sra_file_path in metadata file
		python3 $RESOURCE_ROOT/extract_metadata.py --metadata $metadata_file --config_file $config_file
			
		# Check python3 exit code
		if [[ $? != 0 ]]
		then 
			exit 1
		fi
		;;
esac

# Check if upload_log.csv exists. If exists, copy it to pipeline directory
if [[ -f $WORK_DIR/upload_log.csv ]]
then	
	# Change directory and config paths in upload_log.csv to docker directory
	cp $WORK_DIR/upload_log.csv $RESOURCE_ROOT/upload_log.csv 2>/dev/null
fi

# Copy submit.ready to pipeline directory. If exists, copy it to pipeline directory
if [[ -f $WORK_DIR/submit.ready ]]
then
    cp $WORK_DIR/submit.ready $RESOURCE_ROOT/submit.ready 2>/dev/null
fi

# Copy gisaid_uploader.log to pipeline directory. If exists, copy it to pipeline directory
if [[ -f $WORK_DIR/gisaid_uploader.log ]]
then
    cp $WORK_DIR/gisaid_uploader.log $RESOURCE_ROOT/gisaid_uploader.log 2>/dev/null
fi

# Copy gisaid_uploader.authtoken to pipeline directory. If exists, copy it to pipeline directory
if [[ -f $WORK_DIR/gisaid_uploader.authtoken ]]
then
    cp $WORK_DIR/gisaid_uploader.authtoken $RESOURCE_ROOT/gisaid_uploader.authtoken 2>/dev/null
fi


##################################################################################################



# Execute the submission pipeline
python3 $api $arg_list

# Check python3 exit code
if [[ $? != 0 ]]
then 
	exit 1
fi



##################################################################################################


# Copy upload log back to working directory so users can access it
case $unique_name in 
	"") ;;
	*)
		# Check if upload_log.csv exists. If exists, copy it back to user directory
		if [[ -f $RESOURCE_ROOT/upload_log.csv ]]
		then
			# Change directory and config paths in upload_log.csv to user directory
			python3 $RESOURCE_ROOT/extract_upload_log.py --upload_log $RESOURCE_ROOT/upload_log.csv --unique_name $unique_name --user_config_file $provided_config
			
			# Check python3 exit code
			if [[ $? != 0 ]]
			then 
				exit 1
			fi
		fi
		;;
esac

# Copy submit.ready back to working directory so users can access it
if [[ -f $RESOURCE_ROOT/submit.ready ]]
then
    cp $RESOURCE_ROOT/submit.ready $WORK_DIR/submit.ready 2>/dev/null
fi

# Copy Test_BioProject_report.xml directory back to working directory so users can access it
if [[ -f $RESOURCE_ROOT/test_input/Test_BioProject_report.xml ]]
then
    cp $RESOURCE_ROOT/test_input/Test_BioProject_report.xml $WORK_DIR/Test_BioProject_report.xml 2>/dev/null
fi

# Copy gisaid_uploader.log back to working directory so users can access it
if [[ -f $RESOURCE_ROOT/gisaid_uploader.log ]]
then
    cp $RESOURCE_ROOT/gisaid_uploader.log $WORK_DIR/gisaid_uploader.log 2>/dev/null
fi

# Copy gisaid_uploader.authtoken back to working directory so users can access it
if [[ -f $RESOURCE_ROOT/gisaid_uploader.authtoken ]]
then
    cp $RESOURCE_ROOT/gisaid_uploader.authtoken $WORK_DIR/gisaid_uploader.authtoken 2>/dev/null
fi
